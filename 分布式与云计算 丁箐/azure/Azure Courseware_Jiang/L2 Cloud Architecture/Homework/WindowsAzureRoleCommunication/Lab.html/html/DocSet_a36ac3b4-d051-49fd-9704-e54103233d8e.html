<html dir="ltr" xmlns:MSHelp="http://msdn.microsoft.com/mshelp" xmlns:dt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882" xmlns:xlink="http://www.w3.org/1999/xlink">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta name="save" content="history" />
    <xml>
      <MSHelp:TOCTitle Title="Exercise 1: Using Worker Role External Endpoints" />
      <MSHelp:RLTitle Title="Exercise 1: Using Worker Role External Endpoints" />
      <MSHelp:Attr Name="DocSet" Value="docSet" />
      <MSHelp:Attr Name="TopicType" Value="kbOrient" />
      <MSHelp:Attr Name="Locale" Value="kbEnglish" />
      <MSHelp:Attr Name="AssetId" Value="{GUID}" />
    </xml>
    <title>Exercise 1: Using Worker Role External Endpoints</title>
    <link rel="stylesheet" type="text/css" href="../local/Classic.css" />
    <script src="../local/EventUtilities.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/SplitScreen.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/Dropdown.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/script.js" type="text/javascript" language="jscript"> </script>
  </head>
  <body>
    <input type="hidden" id="userDataCache" class="userDataStyle" />
    <input type="hidden" id="hiddenScrollOffset" />
    <img id="dropDownImage" style="display:none; height:0; width:0;" alt="DropDown image" src="../local/drpdown.gif" />
    <img id="dropDownHoverImage" style="display:none; height:0; width:0;" alt="DropDownHover image" src="../local/drpdown_orange.gif" />
    <img id="collapseImage" style="display:none; height:0; width:0;" alt="Collapse image" src="../local/collapse_all.gif" />
    <img id="expandImage" style="display:none; height:0; width:0;" alt="Expand image" src="../local/expand_all.gif" />
    <img id="collapseAllImage" style="display:none; height:0; width:0;" alt="CollapseAll image" src="../local/collall.gif" />
    <img id="expandAllImage" style="display:none; height:0; width:0;" alt="ExpandAll image" src="../local/expall.gif" />
    <img id="copyImage" style="display:none; height:0; width:0;" alt="Copy image" src="../local/copycode.gif" />
    <img id="copyHoverImage" style="display:none; height:0; width:0;" alt="CopyHover image" src="../local/copycodeHighlight.gif" />
    <div id="header">
      <table width="100%" id="topTable">
        <tr id="headerTableRow1">
          <td align="left">
            <span id="runningHeaderText">Windows Azure:  Worker Role Communication</span>
          </td>
        </tr>
        <tr id="headerTableRow2">
          <td align="left">
            <span id="nsrTitle">Exercise 1: Using Worker Role External Endpoints</span>
          </td>
        </tr>
        <tr id="headerTableRow3">
          <td />
        </tr>
      </table>
      <table width="100%" id="bottomTable" cellspacing="0" cellpadding="0">
        <tr>
          <td>
            <span onclick="ExpandCollapseAll(toggleAllImage)" onkeypress="ExpandCollapseAll_CheckKey(toggleAllImage)" tabindex="0" style="cursor:default;display:none;">
              <img id="toggleAllImage" class="toggleAll" alt="CollapseAll image" src="../local/collall.gif" />
              <label id="collapseAllLabel" for="toggleAllImage" style="display: none;">Collapse All</label>
              <label id="expandAllLabel" for="toggleAllImage" style="display: none;">Expand All</label> </span>
            <span id="languageFilterToolTip" onmouseover="languageFilterImage.src=dropDownHoverImage.src;" onmouseout="languageFilterImage.src=dropDownImage.src;" tabindex="0" style="cursor:default;">
              <img id="languageFilterImage" alt="DropDown image" src="../local/drpdown.gif" />
              <label id="showAllLabel" for="languageFilterImage" style="display: none;">Language Filter: All</label>
              <label id="multipleLabel" for="languageFilterImage" style="display: none;">Language Filter: Multiple</label>
              <label id="vbLabel" for="languageFilterImage" style="display: none;">Language Filter: Visual Basic</label>
              <label id="csLabel" for="languageFilterImage" style="display: none;">Language Filter: C#</label>
            </span>
          </td>
        </tr>
      </table>
      <div id="languageSpan">
        <input type="checkbox" name="languageFilter" onclick="SetLanguage(this)" id="vbUsageCheckbox" />
        <label class="languageFilter" for="vbUsageCheckbox">Visual Basic Usage</label>
        <br />
        <input type="checkbox" name="languageFilter" onclick="SetLanguage(this)" id="csCheckbox" />
        <label class="languageFilter" for="csCheckbox">C#</label>
        <br />
      </div>
    </div>
    <div id="mainSection">
      <div id="mainBody">
        <div id="allHistory" class="saveHistory" onsave="saveAll()" onload="loadAll()" />
        <p>During this exercise, you will implement the WCF chat service. This involves defining an external endpoint for the worker role, implementing the service contract and updating the worker role to host the service at the external endpoint.  </p>
        <p>Windows Azure allows you to create as many instances of a worker role as you require, which means that you are able to host the chat service in many different nodes simultaneously. However, in this initial implementation, each instance maintains its own list of sessions. This allows clients connected to the same worker role to communicate with each other but prevents them from exchanging messages with peers that have active sessions in other worker roles. In the next exercise, you will see how to communicate worker roles and exchange session information between them.</p>
        <p>
          <img src="images\691430f4-d996-4e87-b86f-51a1117ccd43.png" />
        </p>
        <p>
          <b>Figure 1</b>
          <br />
          <i>Clients can only communicate with peers connected to the same worker role</i>
        </p>
        <br />
        <a name="_Toc249249692" href="#">
          <span />
        </a>
        <p>
          <b>Task 1 – Exploring the AzureTalk Solution</b>
        </p>
        <p>In this task, you open the starting solution and become familiar with the code.</p>
        <ol>
          <li>Open Microsoft Visual Studio 2008 in elevated administrator mode, from <b>Start | All Programs | Microsoft Visual Studio 2008</b> by right clicking the <b>Microsoft Visual Studio 2008</b> shortcut and choosing <b>Run as Administrator</b>.</li>
          <li>In the <b>File</b> menu, choose <b>Open</b> and then <b>Project/Solution</b>. In the <b>Open Project</b> dialog, browse to <b>Ex1-WorkerExternalEndPoints\Begin</b> in the <b>Source</b> folder of the lab, select <b>Begin.sln</b> in the folder for the language of your preference (Visual C# or Visual Basic) and click <b>Open</b>.</li>
          <li>The solution contains the following projects:<p><img src="images\202b211b-4786-40ac-b93a-dfca4fa53206.png" /></p><p><b>Figure 2</b><br /><i>Solution Explorer showing the AzureTalk solution</i></p><br /><table style=""><tr valign="top"><td><p><b>AzureTalk</b></p></td><td><p>A standard cloud service project configured to support a single worker role named <b>AzureTalk.Service</b>. </p></td></tr><tr valign="top"><td><p><b>AzureTalk.Client</b></p></td><td><p>A WPF client application that can connect to the chat service to exchange messages with peers. It implements the service callback contract and can receive notifications from the service. In this hands-on lab, you will use this application to test the chat service.</p></td></tr><tr valign="top"><td><p><b>AzureTalk.Contract</b></p></td><td><p>A class library project that contains the service and data contracts for the chat service and the callback contract implement by the client application. The client application and the service share this project.</p></td></tr><tr valign="top"><td><p><b>AzureTalk.Service</b></p></td><td><p>A worker role that hosts the chat service and listens over an external TCP endpoint.</p></td></tr></table></li>
        </ol>
        <br />
        <a name="_Toc249249693" href="#">
          <span />
        </a>
        <p>
          <b>Task 2 – Hosting a WCF Service in a Worker Role</b>
        </p>
        <p>In this task, you configure the worker role to define an external endpoint and then create a WCF service host to listen at this endpoint.</p>
        <ol>
          <li>Enable full trust for the worker role. To do this, in <b>Solution Explorer</b>, expand the <b>Roles</b> node in the <b>AzureTalk</b> cloud project, right-click the <b>AzureTalk.Service</b> role and choose <b>Properties</b>. In the role <b>Properties</b> window, select the <b>Configuration</b> tab and choose the <b>Full Trust</b> option. <p><img src="images\7852aed8-5889-417d-a6b8-e0ae44aed18a.png" /></p><p><b>Figure 3</b><br /><i>Configuring the trust level of the worker role</i></p><br /></li>
          <li>Define an external endpoint for the worker role. In the role <b>Properties</b> window, change to the <b>Endpoints</b> tab and click <b>Add Endpoint</b>. Set the name of the new endpoint to “<i>ChatService</i>”, leave the <b>Type</b> as “<i>Input</i>” and the <b>Protocol</b> as “<i>tcp</i>”, and then set the <b>Port</b> number to the value “<b>3030</b>”. The worker role will use this TCP endpoint to host the chat service.<p><img src="images\5a4dce0d-b317-4f1a-9b6f-0d2ca999f246.png" /></p><p><b>Figure 4</b><br /><i>Defining the external endpoint for the worker role</i></p><br /></li>
          <li>Press <b>CTRL + S</b> to save the changes to the worker role configuration.</li>
          <li>Open the <b>WorkerRole.cs</b> file (for Visual C# projects) or <b>WorkerRole.vb</b> file (for Visual Basic projects) in the <b>AzureTalk.Service</b> project. This file contains the entry point of the worker role.</li>
          <li>In the <b>WorkerRole</b> class, define a WCF <b>ServiceHost</b> member field.<p>(Code Snippet – <i>Windows Azure Worker Role Communication – Ex01 ServiceHost - CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>/// &lt;summary&gt;ServiceHost object for internal and external endpoints.&lt;/summary&gt;</b><b>private ServiceHost serviceHost;</b></pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>Windows Azure Worker Role Communication – Ex01 ServiceHost - VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>''' &lt;summary&gt;ServiceHost object for internal and external endpoints.&lt;/summary&gt;</b><b>Private serviceHost As ServiceHost</b></pre></td></tr></table></span></div><br /></li>
          <li>Add the <b>StartChatService</b> method to the <b>WorkerRole</b> class. This method creates and configures the WCF service host instance for the chat service.<p>(Code Snippet – <i>Windows Azure Worker Role Communication – Ex01 StartChatService - CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>/// &lt;summary&gt;</b><b>/// Starts the service host object for the internal </b><b>/// and external endpoints of the chat service.</b><b>/// &lt;/summary&gt;</b><b>/// &lt;param name="retries"&gt;Specifies the number of retries to </b><b>/// start the service in case of failure.&lt;/param&gt;</b><b>private void StartChatService(int retries)</b><b>{</b><b>  // recycle the role if host cannot be started </b><b>  // after the specified number of retries</b><b>  if (retries == 0)</b><b>  {</b><b>    RoleEnvironment.RequestRecycle();</b><b>    return;</b><b>  }</b><b>  Trace.TraceInformation("Starting chat service host...");</b><b>  this.serviceHost = new ServiceHost(typeof(ChatService));</b><b>  // Recover the service in case of failure. </b><b>  // Log the fault and attempt to restart the service host. </b><b>  this.serviceHost.Faulted += (sender, e) =&gt;</b><b>  {</b><b>    Trace.TraceError("Host fault occured. Aborting and restarting the host. Retry count: {0}", retries);</b><b>    this.serviceHost.Abort();</b><b>    this.StartChatService(--retries);</b><b>  };</b><b>  // use NetTcpBinding with no security</b><b>  NetTcpBinding binding = new NetTcpBinding(SecurityMode.None);</b><b>  // define an external endpoint for client traffic</b><b>  RoleInstanceEndpoint externalEndPoint =</b><b>      RoleEnvironment.CurrentRoleInstance.InstanceEndpoints["ChatService"];</b><b>  this.serviceHost.AddServiceEndpoint(</b><b>     typeof(IChatService),</b><b>     binding,</b><b>     String.Format("net.tcp://{0}/ChatService", externalEndPoint.IPEndpoint));</b><b>  try</b><b>  {</b><b>    this.serviceHost.Open();</b><b>    Trace.TraceInformation("Chat service host started successfully.");</b><b>  }</b><b>  catch (TimeoutException timeoutException)</b><b>  {</b><b>    Trace.TraceError("The service operation timed out. {0}",</b><b>                     timeoutException.Message);</b><b>  }</b><b>  catch (CommunicationException communicationException)</b><b>  {</b><b>    Trace.TraceError("Could not start chat service host. {0}", </b><b>                     communicationException.Message);</b><b>  }</b><b>}</b></pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>Windows Azure Worker Role Communication – Ex01 StartChatService - VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>''' &lt;summary&gt;</b><b>''' Starts the service host object for the internal </b><b>''' and external endpoints of the chat service.</b><b>''' &lt;/summary&gt;</b><b>''' &lt;param name="retries"&gt;Specifies the number of retries to </b><b>''' start the service in case of failure.&lt;/param&gt;</b><b>Private Sub StartChatService(ByVal retries As Integer)</b><b>  ' recycle the role if host cannot be started </b><b>  ' after the specified number of retries</b><b>  If retries = 0 Then</b><b>    RoleEnvironment.RequestRecycle()</b><b>    Return</b><b>  End If</b><b>  Trace.TraceInformation("Starting chat service host...")</b><b>  Me.serviceHost = New ServiceHost(GetType(ChatService))</b><b>  ' Recover the service in case of failure. </b><b>  ' Log the fault and attempt to restart the service host. </b><b>  AddHandler Me.serviceHost.Faulted, Function(sender, e) OnFaulted(sender, e, retries)</b><b>  ' use NetTcpBinding with no security</b><b>  Dim binding As New NetTcpBinding(SecurityMode.None)</b><b>  ' define an external endpoint for client traffic</b><b>  Dim externalEndPoint As RoleInstanceEndpoint = RoleEnvironment.CurrentRoleInstance.InstanceEndpoints("ChatService")</b><b>  Me.serviceHost.AddServiceEndpoint(GetType(IChatService), binding, String.Format("net.tcp://{0}/ChatService", externalEndPoint.IPEndpoint))</b><b>  Try</b><b>    Me.serviceHost.Open()</b><b>    Trace.TraceInformation("Chat service host started successfully.")</b><b>  Catch timeoutException As TimeoutException</b><b>    Trace.TraceError("The service operation timed out. {0}", timeoutException.Message)</b><b>  Catch communicationException As CommunicationException</b><b>    Trace.TraceError("Could not start chat service host. {0}", communicationException.Message)</b><b>  End Try</b><b>End Sub</b><b>Private Function OnFaulted(ByVal sender As Object, ByVal e As Object, ByVal retries As Integer) As Object</b><b>  Trace.TraceError("Host fault occured. Aborting and restarting the host. Retry count: {0}", retries)</b><b>  Me.serviceHost.Abort()</b><b>  retries -= 1</b><b>  Me.StartChatService(retries)</b><b>  Return Nothing</b><b>End Function</b></pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The <b>StartChatService</b> method creates and configures a service host to expose the chat service using the implementation provided by the <b>ChatService</b> class. <br />The code configures a single endpoint for the contract defined by the <b>IChatService</b> interface in the <b>AzureTalk.Contract</b> project using a <b>NetTcpBinding</b> binding to enable TCP message delivery using a binary encoding. For this service, the binding configuration specifies no transport security. <br />To determine the service endpoint address, the method uses the <b>RoleEnvironment </b>to obtain a reference the “<b>ChatService</b>” endpoint for the current instance, which you previously defined for the worker role. Note that this address is the internal address as seen by the worker role instance located behind the load balancer.<br />To provide a certain degree of fault tolerance, the method subscribes to the <b>Faulted</b> event of the service host to restart the service in case of failure and attempts its recovery by re-starting the host. After a number of failed retries, the worker role requests to be recycled. Note that for a Visual Basic project, the handler for the Faulted event is located in a separate method, unlike the C# code, which uses a lambda expression to define the event handler.</td></tr></table><p /></div><br /></li>
          <li>Next, update the <b>Run</b> method of the worker role to create and start the chat service. To do this, insert a call to the <b>StartChatService</b> method as shown (highlighted) in the code below.<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public override void Run(){  Trace.TraceInformation("Worker Process entry point called.");<b>  this.StartChatService(3);</b>  while (true)  {    Thread.Sleep(300000);    Trace.TraceInformation("Working...");  }}</pre></td></tr></table></span></div><br /><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Public Overrides Sub Run()  Trace.TraceInformation("Worker Process entry point called.")<b>  Me.StartChatService(3)</b>  Do    Thread.Sleep(300000)    Trace.TraceInformation("Working...")  LoopEnd Sub</pre></td></tr></table></span></div><br /></li>
          <li>Press <b>CTRL + S</b> to save the changes to the file.</li>
        </ol>
        <br />
        <a name="_Toc249249694" href="#">
          <span />
        </a>
        <p>
          <b>Task 3 – Implementing the Chat Service</b>
        </p>
        <p>In this task, you implement the chat service as specified in the contract defined by the <b>IChatService</b> interface of the <b>AzureTalk.Contract</b> project.</p>
        <ol>
          <li>Open <b>ChatService.cs</b> (for Visual C# projects) or <b>ChatService.vb</b> (for Visual Basic projects) in the <b>AzureTalk.Service</b> project. This file contains a skeleton implementation of the chat service contract. In the next steps, you will implement the service operations.</li>
          <li>Locate the <b>Register</b> operation and replace its body with the following code. <p>(Code Snippet – <i>Windows Azure Worker Role Communication</i>–<i>Ex01 Register - CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>/// &lt;summary&gt;/// Called by clients to announce they are connected at this chat endpoint./// &lt;/summary&gt;/// &lt;param name="userName"&gt;The user name of the client.&lt;/param&gt;/// &lt;returns&gt;The ClientInformation object for the new session.&lt;/returns&gt;public ClientInformation Register(string userName){<b>  // retrieve session information</b><b>  string roleId = RoleEnvironment.CurrentRoleInstance.Id;</b><b>  string sessionId = OperationContext.Current.SessionId;</b><b>  IClientNotification callback = OperationContext.Current.GetCallbackChannel&lt;IClientNotification&gt;();</b><b>  SessionInformation session;</b><b>  if (SessionManager.CreateOrUpdateSession(sessionId, userName, roleId, callback, out session))</b><b>  {</b><b>    // ensure that the session is killed when channel is closed</b><b>    OperationContext.Current.Channel.Closed += (sender, e) =&gt;</b><b>    {</b><b>      SessionManager.RemoveSession(sessionId);</b><b>      NotifyConnectedClients(session);</b><b>      Trace.TraceInformation("Session '{0}' by user '{1}' has been closed in role '{2}'.", sessionId, userName, roleId);</b><b>    };</b><b>    Trace.TraceInformation("Session '{0}' by user '{1}' has been opened in role '{2}'.", sessionId, userName, roleId);</b><b>  }</b><b>  // Notify clients connected to this role</b><b>  NotifyConnectedClients(session);</b><b>  return new ClientInformation()</b><b>  {</b><b>    SessionId = sessionId,</b><b>    UserName = userName,</b><b>    RoleId = roleId</b><b>  };</b>}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>Windows Azure Worker Role Communication</i>–<i>Ex01 Register - VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>''' &lt;summary&gt;''' Called by clients to announce they are connected at this chat endpoint.''' &lt;/summary&gt;''' &lt;param name="userName"&gt;The user name of the client.&lt;/param&gt;''' &lt;returns&gt;The ClientInformation object for the new session.&lt;/returns&gt;Public Function Register(ByVal userName As String) As ClientInformation Implements IChatService.Register<b>' retrieve session information</b><b>  Dim roleId As String = RoleEnvironment.CurrentRoleInstance.Id</b><b>  Dim sessionId As String = OperationContext.Current.SessionId</b><b>  Dim callback As IClientNotification = OperationContext.Current.GetCallbackChannel(Of IClientNotification)()</b><b>  Dim session As SessionInformation</b><b>  If SessionManager.CreateOrUpdateSession(sessionId, userName, roleId, callback, session) Then</b><b>    ' ensure that the session is killed when channel is closed</b><b>    AddHandler OperationContext.Current.Channel.Closed, Function(sender, e) OnClosed(sender, e, sessionId, session, userName, roleId)</b><b>    Trace.TraceInformation("Session '{0}' by user '{1}' has been opened in role '{2}'.", sessionId, userName, roleId)</b><b>  End If</b><b>  ' Notify clients connected to this role</b><b>  NotifyConnectedClients(session)</b><b>  Return New ClientInformation() With {.SessionId = sessionId, .UserName = userName, .RoleId = roleId}</b>End Function</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td> The <b>Register</b> implementation obtains the ID of the current worker role and the ID for the session established by the WCF infrastructure. In addition, it retrieves the callback channel to the client instance that called the service, which it can use to call operations on the client through its <b>IClientNotify</b> callback contract. With this information, the service calls the Session Manager to either create a new session or, if the client has registered previously, return an existing session.<br />For new sessions, the method attaches a handler to the <b>Closed</b> event of the channel to remove the session once the channel is closed.<br />The code invokes <b>NotifyConnectedClients</b>, both in the main body and in the handler for the <b>Closed </b>event, to inform other clients connected to this worker role that a new session has started or ended. </td></tr></table><p /></div><br /></li>
          <li>If you implement your code in Visual Basic, add the <b>OnClosed </b>function.<p>(Code Snippet – <i>Windows Azure Worker Role Communication</i>–<i>Ex01 OnClosed - VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>Private Function OnClosed(ByVal sender As Object, ByVal e As Object, ByVal sessionId As String, ByVal session As SessionInformation, ByVal userName As String, ByVal roleId As String) As Object</b><b>    SessionManager.RemoveSession(sessionId)</b><b>    NotifyConnectedClients(session)</b><b>    Trace.TraceInformation("Session '{0}' by user '{1}' has been closed in role '{2}'.", sessionId, userName, roleId)</b><b>    Return Nothing</b><b>End Function</b></pre></td></tr></table></span></div><br /></li>
          <li>Next, replace the body of the <b>SendMessage</b> operation with the code shown below.<p>(Code Snippet – <i>Windows Azure Worker Role Communication</i>–<i>Ex01 SendMessage - CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>/// &lt;summary&gt;/// Sends a message to a user./// &lt;/summary&gt;/// &lt;param name="message"&gt;The message to send.&lt;/param&gt;/// &lt;param name="sessionId"&gt;The recipient's session Id.&lt;/param&gt;public void SendMessage(string message, string sessionId){<b>  string fromSessionId = OperationContext.Current.SessionId;</b><b>  this.DeliverMessage(message, fromSessionId, sessionId);</b>}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>Windows Azure Worker Role Communication</i>–<i>Ex01 SendMessage - VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>''' &lt;summary&gt;''' Sends a message to a user.''' &lt;/summary&gt;''' &lt;param name="message"&gt;The message to send.&lt;/param&gt;''' &lt;param name="sessionId"&gt;The recipient's session Id.&lt;/param&gt;Public Sub SendMessage(ByVal message As String, ByVal sessionId As String) Implements IChatService.SendMessage<b>  Dim fromSessionId As String = OperationContext.Current.SessionId</b><b>  Me.DeliverMessage(message, fromSessionId, sessionId)</b>End Sub</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The <b>SendMessage</b> operation retrieves the current session ID from the execution context of the service method, which is the same as the one used by the <b>Register</b> operation to register the client with the Session Manager, and then calls the <b>DeliverMessage</b> method to send the message to its destination. You will implement the <b>DeliverMessage</b> method shortly.</td></tr></table><p /></div><br /></li>
          <li>Finally, to complete the implementation of the contract, replace the body of the <b>GetConnectedClients</b> operation with the code shown below, which returns the list of active client sessions registered with the Session Manager.<p>(Code Snippet – <i>Windows Azure Worker Role Communication</i>–<i>Ex01 GetConnectedClients - CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>/// &lt;summary&gt;/// Returns a list of connected clients./// &lt;/summary&gt;/// &lt;returns&gt;The list of active sessions.&lt;/returns&gt;public IEnumerable&lt;ClientInformation&gt; GetConnectedClients(){<b>  return from session in SessionManager.GetActiveSessions()</b><b>         select new ClientInformation()</b><b>         {</b><b>           SessionId = session.SessionId,</b><b>           UserName = session.UserName,</b><b>           RoleId = session.RoleId</b><b>         };</b>}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>Windows Azure Worker Role Communication</i>–<i>Ex01 GetConnectedClients - VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>''' &lt;summary&gt;''' Returns a list of connected clients.''' &lt;/summary&gt;''' &lt;returns&gt;The list of active sessions.&lt;/returns&gt;Public Function GetConnectedClients() As IEnumerable(Of ClientInformation) Implements IChatService.GetConnectedClients<b>Return _</b><b>  From session In SessionManager.GetActiveSessions() _</b><b>  Select New ClientInformation() With {.SessionId = session.SessionId, .UserName = session.UserName, .RoleId = session.RoleId}</b>End Function</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The code retrieves a list of active sessions from the Session Manager and returns a projection of <b>ClientInformation</b> objects. These objects, which are defined in the data contract of the service, contain a subset of the session information more suitable for transmission to clients.</td></tr></table><p /></div><br /></li>
          <li>Add a <b>DeliverMessage</b> method to the <b>ChatService</b> class. This method sends messages to clients connected to the worker role.<p>(Code Snippet – <i>Windows Azure Worker Role Communication</i>–<i>Ex01 DeliverMessage - CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>/// &lt;summary&gt;</b><b>/// Delivers a message to a client in the current worker role.</b><b>/// &lt;/summary&gt;</b><b>/// &lt;param name="message"&gt;The message to forward.&lt;/param&gt;</b><b>/// &lt;param name="fromSessionId"&gt;The session ID of the message originator.&lt;/param&gt;</b><b>/// &lt;param name="toSessionId"&gt;The session ID of the message recipient.&lt;/param&gt;</b><b>public void DeliverMessage(string message, string fromSessionId, string toSessionId)</b><b>{</b><b>  SessionInformation fromSession = SessionManager.GetSession(fromSessionId);</b><b>  SessionInformation toSession = SessionManager.GetSession(toSessionId);</b><b>  if ((fromSession != null) &amp;&amp; (toSession != null))</b><b>  {</b><b>    // retrieve the callback channel to the client</b><b>    IClientNotification callback = toSession.Callback;</b><b>    if (callback != null)</b><b>    {</b><b>      callback.DeliverMessage(message, fromSessionId, toSessionId);</b><b>      Trace.TraceInformation("Message '{0}' sent from '{1}' to '{2}'.",</b><b>                        message, fromSession.UserName, toSession.UserName);</b><b>    }</b><b>  }</b><b>}</b></pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>Windows Azure Worker Role Communication</i>–<i>Ex01 DeliverMessage - VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>''' &lt;summary&gt;</b><b>''' Delivers a message to a client in the current worker role.</b><b>''' &lt;/summary&gt;</b><b>''' &lt;param name="message"&gt;The message to forward.&lt;/param&gt;</b><b>''' &lt;param name="fromSessionId"&gt;The session ID of the message originator.&lt;/param&gt;</b><b>''' &lt;param name="toSessionId"&gt;The session ID of the message recipient.&lt;/param&gt;</b><b>Public Sub DeliverMessage(ByVal message As String, ByVal fromSessionId As String, ByVal toSessionId As String)</b><b>  Dim fromSession As SessionInformation = SessionManager.GetSession(fromSessionId)</b><b>  Dim toSession As SessionInformation = SessionManager.GetSession(toSessionId)</b><b>  If (fromSession IsNot Nothing) AndAlso (toSession IsNot Nothing) Then</b><b>    ' retrieve the callback channel to the client</b><b>    Dim callback As IClientNotification = toSession.Callback</b><b>    If callback IsNot Nothing Then</b><b>      callback.DeliverMessage(message, fromSessionId, toSessionId)</b><b>      Trace.TraceInformation("Message '{0}' sent from '{1}' to '{2}'.", message, fromSession.UserName, toSession.UserName)</b><b>    End If</b><b>  End If</b><b>End Sub</b></pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The code in this method retrieves the source and target sessions and then uses the callback channel to the recipient, which is stored in the target session, to deliver the message over the duplex channel. To do this, it invokes the <b>DeliverMessage</b> operation of the <b>IClientNotification</b> contract implemented by the client.</td></tr></table><p /></div><br /></li>
          <li>As a final step, add the <b>NotifyConnectedClients</b> method to the class. This method notifies clients connected to this worker role about session activities, namely clients connecting and disconnecting. <p>(Code Snippet – <i>Windows Azure Worker Role Communication</i>–<i>Ex01 NotifyConnectedClients - CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>/// &lt;summary&gt;</b><b>/// Notifies clients connected to this worker role to update their active sessions list when a new client connects or disconnects.</b><b>/// &lt;/summary&gt;</b><b>/// &lt;param name="clientInfo"&gt;The ClientInformation object for the client.&lt;/param&gt;</b><b>private static void NotifyConnectedClients(ClientInformation clientInfo)</b><b>{</b><b>  foreach (SessionInformation client in SessionManager.GetActiveSessions())</b><b>  {</b><b>    if (client.Callback != null)</b><b>    {</b><b>      try</b><b>      {</b><b>        client.Callback.UpdateClientList(clientInfo);</b><b>      }</b><b>      catch (TimeoutException timeoutException)</b><b>      {</b><b>        Trace.TraceError("Unable to notify client '{0}'. The service operation timed out. {1}", client.UserName, timeoutException.Message);</b><b>        ((ICommunicationObject)client).Abort();</b><b>        client.Callback = null;</b><b>      }</b><b>      catch (CommunicationException communicationException)</b><b>      {</b><b>        Trace.TraceError("Unable to notify client '{0}'. There was a communication problem. {1} - {2}", client.UserName, communicationException.Message, communicationException.StackTrace);</b><b>        ((ICommunicationObject)client).Abort();</b><b>        client.Callback = null;</b><b>      }</b><b>    }</b><b>  }</b><b>}</b></pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>Windows Azure Worker Role Communication</i>–<i>Ex01 NotifyConnectedClients - VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>''' &lt;summary&gt;</b><b>''' Notifies clients connected to this worker role to update their active sessions list when a new client connects or disconnects.</b><b>''' &lt;/summary&gt;</b><b>''' &lt;param name="clientInfo"&gt;The ClientInformation object for the client.&lt;/param&gt;</b><b>Private Shared Sub NotifyConnectedClients(ByVal clientInfo As ClientInformation)</b><b>  For Each client As SessionInformation In SessionManager.GetActiveSessions()</b><b>    If client.Callback IsNot Nothing Then</b><b>      Try</b><b>        client.Callback.UpdateClientList(clientInfo)</b><b>      Catch timeoutException As TimeoutException</b><b>        Trace.TraceError("Unable to notify client '{0}'. The service operation timed out. {1}", client.UserName, timeoutException.Message)</b><b>        CType(client, ICommunicationObject).Abort()</b><b>        client.Callback = Nothing</b><b>      Catch communicationException As CommunicationException</b><b>        Trace.TraceError("Unable to notify client '{0}'. There was a communication problem. {1} - {2}", client.UserName, communicationException.Message, communicationException.StackTrace)</b><b>        CType(client, ICommunicationObject).Abort()</b><b>        client.Callback = Nothing</b><b>      End Try</b><b>    End If</b><b>  Next client</b><b>End Sub</b></pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The <b>NotifyConnectedClients</b> method retrieves a list of active sessions from the Session Manager and then iterates over this list, invoking the <b>UpdateClientList</b> operation of the callback contract to notify clients when a client connects or disconnects.<br />Only clients connected to the current worker role have a valid <b>Callback</b> member in the <b>SessionInformation</b> object; for clients in other worker roles this member is null.</td></tr></table><p /></div></li>
        </ol>
        <p>
          <b>
          </b>
        </p>
        <a name="_Toc249249695" href="#">
          <span />
        </a>
        <p>
          <b>Verification</b>
        </p>
        <p>You are now ready to test the solution. First, you will run the verification against a single instance of the worker role.  To test the service, you will start two instances of the client application and exchange messages between them to determine that messages and notifications flow between clients connected to the service in the worker role. Next, you will repeat the procedure after increasing the number of running instances of the worker role to two.</p>
        <ol>
          <li>Press <b>F5</b> to launch the cloud project in the development fabric.</li>
          <li>Switch to the development fabric UI and ensure that the service has started successfully. Notice that only a single instance of the worker role is currently active.<p><img src="images\b897d7a3-a1f1-4940-bc71-7fa21f49ae9a.png" /></p><p><b>Figure 5</b><br /><i>Chat service executing successfully in the development fabric</i></p><br /></li>
          <li>In <b>Solution Explorer</b>, right-click the <b>AzureTalk.Client</b> project, point to <b>Debug</b> and select <b>Start new instance</b>.</li>
          <li>In the main window of the application, enter a user name for the first client and click <b>Sign In</b>. Note that at this point, this is the only client connected to the service and the <b>Online Users</b> list is predictably empty. <p><img src="images\74eb0080-6eed-4f2b-a7fb-ba7159e579b5.png" /></p><p><b>Figure 6</b><br /><i>Signing in to the chat service</i></p><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The following instructions assume that you are deploying locally and testing against the service running in the development fabric.  You may wish to test the service running in Windows Azure, in which case, after you have deployed the service package and before you sign in, you will need to enter the URL that points to your deployment in the client application <b>Server URL</b> field as shown below:<br /><b><i>net.tcp://&lt;YOUR_DEPLOYED_PROJECT&gt;.cloudapp.net:3030/ChatService</i></b><br />where <b><i>&lt;YOUR_DEPLOYED_PROJECT&gt;</i></b> is the name you chose for your service deployment. For example,<br /><b><i>net.tcp://azureTalk.cloudapp.net:3030/ChatService</i></b></td></tr></table><p /></div><br /></li>
          <li>In the development fabric UI, select the worker role instance to display its log and view the entry for the new session that started. <p><img src="images\eb270972-4504-4ee1-92f3-39cee7ec869e.png" /></p><p><b>Figure 7</b><br /><i>Worker role log showing the new session</i></p><br /></li>
          <li>Start a second instance of the client application and sign in using a different user name.  Notice that the title bar of the application shows the name of the current user and the ID of the worker role where the client is connected. Both clients should display the same connected role ID because there is only one instance of the worker role currently running.<p><img src="images\b836efcf-3cd4-44c8-a170-e27eb13a470a.png" /></p><p><b>Figure 8</b><br /><i>Verifying the connected worker role ID of the client</i></p><br /></li>
          <li>In the second client, notice how the list of online users includes the name of the user registered by the first client. Switch to the first instance of the client application and see how the server immediately alerted this instance about the new session started by the other client.</li>
          <li>In one of the instances of the client application, select a user from the list of online users, type a message and click <b>Send</b>. Switch to the other instance to see the message delivered.</li>
          <li>Optionally, start additional instances and exchange messages with different users. In the development fabric UI, view the messages that users exchange.<p><img src="images\48ac4a95-8cb7-4dd2-9cee-ad17d326fbdf.png" /></p><p><b>Figure 9</b><br /><i>Worker role log showing messages exchanged by clients</i></p><br /></li>
          <li>Finally, click <b>Sign out</b> in one of the instances of the client application.  Switch to the other instance and notice how the server immediately notified the client about the session that ended.</li>
          <li>In the development fabric, view the worker role log to see an event logged for the ending session.</li>
          <li>Press <b>Shift + F5</b> to stop the application running in the development fabric. </li>
          <li>Next, you will configure the service to start a second instance of the worker role and repeat the previous steps. </li>
          <li>In <b>Solution Explorer</b>, expand the <b>Roles</b> node in the <b>AzureTalk</b> project, right-click the <b>AzureTalk.Service</b> role and select <b>Properties</b>. In the <b>Properties</b> window, select the <b>Configuration</b> tab and increase the value of the <b>Instance count</b> to <b>2</b>.<p><img src="images\16c8c611-6f20-4b98-85c4-1466fd29792b.png" /></p><p><b>Figure 10</b><br /><i>Configuring additional instances of the worker role</i></p><br /></li>
          <li>Press <b>F5</b> to launch the cloud project in the development fabric.</li>
          <li>In <b>Solution Explorer</b>, right-click the <b>AzureTalk.Client</b> project, point to <b>Debug</b> and select <b>Start new instance</b>.</li>
          <li>In the main window of the application, enter a user name for the first client and click <b>Sign In</b>.</li>
          <li>Start a second instance of the client application and sign in using a different user name.  Ensure that the second client connects to a different worker role than the first client by verifying the connected role ID of each client in the title bar of the application. <div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The load balancer determines which instance of the worker role responds to a client's request. The development fabric typically assigns connections in round robin fashion, so the second client should normally start a session in a different worker role when it connects.  If necessary, restart one of the client instances until both clients have sessions in different worker roles.</td></tr></table><p /></div><br /></li>
          <li>Notice that the list of active users in either client does not show the other client so they are unable to exchange messages.<p><img src="images\6f567673-e553-4177-89d4-c98e3478ee09.png" /></p><p><b>Figure 11</b><br /><i>Clients connected to different worker roles cannot communicate</i></p><br /></li>
          <li>Start a third instance of the client and sign in. Notice that this time, the client connected to the same instance of the worker role as the new client is shown in the list of online users and vice versa.<div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td> In the current implementation, worker roles do not share session information and consequently, behave as independent servers. Clients connected to one role cannot exchange messages with clients in any other role. In the next exercise, you will remove this restriction by enabling worker roles to exchange messages and session information and allow all clients to communicate, regardless of the worker role where they establish their session.</td></tr></table><p /></div></li>
        </ol>
        <br />
      </div>
      <div id="footer">
        <div class="footerLine">
          <img src="../local/footer.gif" alt="Footer image" width="100%" height="3px" />
        </div>To give feedback please write to azcfeed@microsoft.com<p />Copyright © 2010 by Microsoft Corporation. All rights reserved.</div>
    </div>
  </body>
</html>